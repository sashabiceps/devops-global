az vm create \
  --resource-group rg-global \
  --name vm-global \
  --image Ubuntu2204 \
  --admin-username admlnx \
  --admin-password fiap@2tdsvms \
  --size Standard_B2s \
  --public-ip-address-dns-name vm-global-unique \
  --authentication-type password \
  --nsg-rule SSH \
  --storage-sku StandardSSD_LRS \
  --location eastus


ssh admlnx@<IP_PÚBLICO_DA_VM>
# Senha: fiap@2tdsvms

sudo apt-get update && sudo apt-get upgrade -y && \
sudo apt-get install -y \
    docker.io \
    docker-compose \
    git \
    curl \
    jq \
    openjdk-17-jdk \
    maven


curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

sudo usermod -aG docker $USER && \
sudo systemctl enable docker && \
sudo systemctl start Docker

REINICIE O SISTEMA

sudo systemctl start Docker

az vm open-port --resource-group rg-global --name vm-global --port 8081 --priority 1001  # App Java
az vm open-port --resource-group rg-global --name vm-global --port 5432 --priority 1002  # PostgreSQL


git clone https://github.com/Pablo0703/java_global_solution.git && \
cd java_global_solution && \
echo -e "DB_URL=jdbc:postgresql://postgres-container:5432/globaldb\nDB_USERNAME=rm556834\nDB_PASSWORD=070301" > .env



cat > docker-compose.yml <<'EOL'
version: '3.8'
services:
  postgres-db:
    image: postgres:15
    container_name: postgres-container
    environment:
      POSTGRES_USER: rm556834
      POSTGRES_PASSWORD: 070301
      POSTGRES_DB: globaldb
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - global-net

  java-app:
    build: .
    container_name: java-app
    depends_on:
      - postgres-db
    env_file: .env
    ports:
      - "8080:8080"
    networks:
      - global-net

networks:
  global-net:
    driver: bridge

volumes:
  postgres-data:
EOL



docker-compose build && \
docker-compose up -d


docker-compose logs -f


# Verificar containers
docker ps -a

# Testar conexão com PostgreSQL
docker exec -it postgres-container psql -U rm556834 -d globaldb -c "SELECT 1;"

# Testar API (exemplo)
curl http://localhost:8080/usuarios